checkout:
  post:
    - wget http://selenium-release.storage.googleapis.com/2.45/selenium-server-standalone-2.45.0.jar -O selenium-server-standalone.jar

dependencies:
  override:
    - sudo env DEBIAN_FRONTEND=noninteractive apt-get install postfix
    - sudo a2enmod rewrite
    - sudo sed -i -e 's/AllowOverride None/AllowOverride All/g' /etc/apache2/sites-available/default
    - sudo service apache2 start
    - >
        echo "CREATE DATABASE drupal;
        GRANT ALL PRIVILEGES ON drupal.* TO 'drupal'@'localhost'
        IDENTIFIED BY 'drupal';
        FLUSH PRIVILEGES;" | mysql -uroot
    - mysql drupal < db/ivan_wedding.sql
    - sudo composer self-update
    - composer global require drush/drush:6.*
    - composer install -d site/tests
    - sudo rm -r /var/www
    - sudo ln -s ~/drupal-docker-marriage/site /var/www
    - sed -e 's/%%PASSWORD%%/drupal/' site/sites/default/default.settings.php deploy/settings.db > site/sites/default/settings.php
    - sudo install -d -o www-data site/sites/default/files
    - '(cd site && drush updb -y)'
    - sed -i -e 's/%%SELENIUM_IP%%/localhost/' site/tests/behat.yml
    - sed -i -e 's/%%DOCKER_HOST_IP%%:8080/localhost/' site/tests/behat.yml

test:
  pre:
    # Run selenium server in background: https://circleci.com/docs/background-process
    - 'java -jar selenium-server-standalone.jar &> selenium.log':
        background: true
  override:
    - curl -v localhost
    - curl -s localhost | grep RSVP
    - '(cd site/tests && ./vendor/bin/behat)'

